# State of CI in October 2023

This document aims to layout the current structure of CI, and the reasons for making it so.

# Contents

- [Mage Files](#mage)
- [Tests](#tests)
- [Test Cache](#test-cache)
- [Required Jobs](#required-jobs)
- [Possible Improvements](#possible-improvements)
- [Current Bottlenecks](#current-bottlenecks)

# Mage

Magefiles (https://magefile.org/) are used for all developer actions in the repo, replacing make. This, it was thought, would improve readability of our developer scripts, and add lots of debugging support. It also allows for multiple files to help seperate concerns, as well as developers to get armada running with one command and test it `mage localdev minimal testsuite` which has been very useful for making sure the developer experience and CI do not diverge.

# Tests

The test cycle of Armada is controlled through `.github/workflows/test.yml` and `.github/workflows/ci.yml`.

# Test Cache

We cache two locations, and only save the intergration test cache. Those locations are:
- /home/runner/.cache/go-build
- /home/runner/go/pkg/mod

This creates a cache of 1GB. Until we reduce this size, I think caching this way makes sense.

This also means there should always be a cache avaiable for new branches, and the cache will be updated on master. (https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows#restrictions-for-accessing-a-cache)

The save and restore steps are also seperate. This is so that:
- The restore steps everywhere look the same
- To ensure verbosity in seeing exactly what is being cached, and on what conditions.


# Required Jobs

This script is a virtual job in `.github/workflows/check-required.yml`. This is done because of how skipped checks are done in Github Actions, leading the behavior we do not want. This is also the system used in https://github.com/G-Research/fasttrackml and https://github.com/G-Research/ParquetSharp/blob/master/.github/workflows/check-required.yml


# Possible Improvements

## Making the long running tests fail fast

```
======= SUMMARY =======
Test:                  Result: Elapsed:
failure_errimagepull   SUCCESS 1m35.026762492s
failure_1x1            SUCCESS 5.670650584s
cancel_by_ids_1x10     SUCCESS 3.154108841s
gang                   SUCCESS 33.296614529s
failure_oom_1x1        SUCCESS 1m50.079051394s
submit_random_clientid SUCCESS 35.702712919s
submit_2x3             SUCCESS 40.942799667s
failure_namespace      SUCCESS 35.89954344s
cancel_by_id_1x1       SUCCESS 3.055842887s
ingress                SUCCESS 46.061770152s
priorityclass_default  SUCCESS 42.341101304s
cancel_by_set_1x1      SUCCESS 3.157038975s
submit_1x1             SUCCESS 44.959264429s
service_headless       SUCCESS 49.979100877s
submit_fileshare_1x1   SUCCESS 46.358056679s
```

The longest running jobs are failures. For the purposes of the testsuite, they should be shortend. This could save a minute


## Caching Go-Bin

By not caching, we lose 20-25 seconds. Probably not worth it, but worth noting.


# Current Bottlenecks

## Intergration Tests

Downloading Images, Building Armada's Images and setting up kind happen in parallel.
The downloading and building steps both take around 2 minutes, where-as setting up kind takes 4m. This
is the major bottleneck. By not caching go-bin we lose another 20-25 seconds, and then the time we lose from the intergration tests themselves for not failing fast is about a minute.

That means theoretically we could probably get the intergration tests down to 3-4 minutes, but that would require a lot of work.

## Unit Tests

Since the unit tests take longer than the intergration tests, optimizing them does not make much sense