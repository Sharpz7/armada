# State of CI in October 2023

This document aims to layout the current structure of CI, and the reasons for making it so.

# Contents

- [Mage Files](#mage)
- [Tests](#tests)

# Mage

Magefiles (https://magefile.org/) are used for all developer actions in the repo, replacing make. This, to me, improved readability of our developer scripts, added lots of debugging support, and allows for multiple files to help seperate concerns. It also allows developers to get armada running with one command and test it `mage localdev minimal testsuite` which has been very useful for making sure the developer experience and CI do not diverge.

# Tests

The test cycle of Armada is controlled through `.github/workflows/test.yml` and `.github/workflows/ci.yml`.

# Test Cache

We cache three locations, and only save the intergration test cache on master. Those locations are:
- /home/runner/.cache/go-build
- /home/runner/go/pkg/mod
- /home/runner/go/bin

This creates a cache of 1.5GB. The reason for caching the binary folder is that we use a custom `tools.yaml` file that takes a very long time to download, caching is significiantly faster (by over 7 minutes on the intergration tests!). This is also why we only cache on master, so that we don't get overloaded since the limit is 10GB.

This also means there should always be a cache avaiable for new branches, and the cache will be updated on master. (https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows#restrictions-for-accessing-a-cache)


# Required Jobs

This script is a virtual job in `.github/workflows/check-required.yml`. This is done because of how skipped checks are done in Github Actions, leading the behavior we do not want. This is also the system used in https://github.com/G-Research/fasttrackml and https://github.com/G-Research/ParquetSharp/blob/master/.github/workflows/check-required.yml